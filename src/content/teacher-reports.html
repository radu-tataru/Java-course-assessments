<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link href="../assets/css/assessment-styles.css" rel="stylesheet">
</head>
<body style="background: white; padding: 0; margin: 0;">
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-gradient text-white" style="background: var(--bg-gradient);">
                    <div class="card-body py-4">
                        <h2 class="mb-2">
                            <i class="bi bi-download me-2"></i>
                            Reports & Exports
                        </h2>
                        <p class="lead mb-0">Generate and download detailed reports</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Types -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-people text-primary me-2"></i>Student Progress Report
                        </h5>
                        <p class="card-text text-muted">
                            Comprehensive report of all students' progress, assessment scores, and completion rates.
                        </p>
                        <div class="mb-3">
                            <label class="form-label">Format</label>
                            <select class="form-select" id="studentReportFormat">
                                <option value="csv">CSV (Spreadsheet)</option>
                                <option value="pdf">PDF Document</option>
                                <option value="json">JSON Data</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="generateStudentReport()">
                            <i class="bi bi-download me-1"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-clipboard-check text-success me-2"></i>Assessment Summary Report
                        </h5>
                        <p class="card-text text-muted">
                            Overview of all assessments with completion statistics and average scores.
                        </p>
                        <div class="mb-3">
                            <label class="form-label">Format</label>
                            <select class="form-select" id="assessmentReportFormat">
                                <option value="csv">CSV (Spreadsheet)</option>
                                <option value="pdf">PDF Document</option>
                                <option value="json">JSON Data</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="generateAssessmentReport()">
                            <i class="bi bi-download me-1"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-graph-up text-info me-2"></i>Performance Analytics
                        </h5>
                        <p class="card-text text-muted">
                            Detailed analytics including score distributions, trends, and class performance metrics.
                        </p>
                        <div class="mb-3">
                            <label class="form-label">Format</label>
                            <select class="form-select" id="analyticsReportFormat">
                                <option value="csv">CSV (Spreadsheet)</option>
                                <option value="pdf">PDF Document</option>
                                <option value="json">JSON Data</option>
                            </select>
                        </div>
                        <button class="btn btn-info" onclick="generateAnalyticsReport()">
                            <i class="bi bi-download me-1"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-person-check text-warning me-2"></i>Individual Student Report
                        </h5>
                        <p class="card-text text-muted">
                            Detailed report for a specific student including all attempts and progress.
                        </p>
                        <div class="mb-3">
                            <label class="form-label">Select Student</label>
                            <select class="form-select" id="studentSelect">
                                <option value="">Loading students...</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Format</label>
                            <select class="form-select" id="individualReportFormat">
                                <option value="csv">CSV (Spreadsheet)</option>
                                <option value="pdf">PDF Document</option>
                                <option value="json">JSON Data</option>
                            </select>
                        </div>
                        <button class="btn btn-warning" onclick="generateIndividualReport()">
                            <i class="bi bi-download me-1"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Exports -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>Recent Exports
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="recentExports">
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-inbox"></i>
                                <p class="mt-2">No exports yet. Generate a report to get started.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Authentication Utils -->
    <script src="../assets/js/auth-utils.js"></script>

    <script>
        let students = [];
        let recentExports = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!authUtils.isAuthenticated()) {
                window.location.href = '../../index.html';
                return;
            }

            await loadStudents();
        });

        async function loadStudents() {
            try {
                const response = await fetch('/api/users?role=student', {
                    headers: {
                        'Authorization': `Bearer ${authUtils.getToken()}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    students = data.users || [];

                    const select = document.getElementById('studentSelect');
                    select.innerHTML = '<option value="">-- Select a student --</option>' +
                        students.map(s => `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`).join('');
                }
            } catch (error) {
                console.error('Failed to load students:', error);
            }
        }

        async function generateStudentReport() {
            const format = document.getElementById('studentReportFormat').value;
            await generateReport('student-progress', format);
        }

        async function generateAssessmentReport() {
            const format = document.getElementById('assessmentReportFormat').value;
            await generateReport('assessment-summary', format);
        }

        async function generateAnalyticsReport() {
            const format = document.getElementById('analyticsReportFormat').value;
            await generateReport('analytics', format);
        }

        async function generateIndividualReport() {
            const studentId = document.getElementById('studentSelect').value;
            const format = document.getElementById('individualReportFormat').value;

            if (!studentId) {
                alert('Please select a student');
                return;
            }

            await generateReport('individual', format, studentId);
        }

        async function generateReport(type, format, studentId = null) {
            try {
                // Show loading state
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';

                // Fetch data based on report type
                let data = {};

                if (type === 'student-progress') {
                    const response = await fetch('/api/student-data?type=progress', {
                        headers: { 'Authorization': `Bearer ${authUtils.getToken()}` }
                    });
                    data = await response.json();
                } else if (type === 'assessment-summary') {
                    const response = await fetch('/api/analytics?type=overview', {
                        headers: { 'Authorization': `Bearer ${authUtils.getToken()}` }
                    });
                    data = await response.json();
                } else if (type === 'analytics') {
                    const response = await fetch('/api/analytics?type=stats', {
                        headers: { 'Authorization': `Bearer ${authUtils.getToken()}` }
                    });
                    data = await response.json();
                } else if (type === 'individual' && studentId) {
                    const [userResponse, attemptsResponse] = await Promise.all([
                        fetch(`/api/users/${studentId}`, {
                            headers: { 'Authorization': `Bearer ${authUtils.getToken()}` }
                        }),
                        fetch(`/api/student-data?type=attempts&userId=${studentId}`, {
                            headers: { 'Authorization': `Bearer ${authUtils.getToken()}` }
                        })
                    ]);
                    const userData = await userResponse.json();
                    const attemptsData = await attemptsResponse.json();
                    data = { user: userData.user, attempts: attemptsData.attempts };
                }

                // Convert to selected format
                if (format === 'csv') {
                    downloadCSV(data, type);
                } else if (format === 'json') {
                    downloadJSON(data, type);
                } else if (format === 'pdf') {
                    alert('PDF export coming soon! For now, please use CSV or JSON format.');
                }

                // Add to recent exports
                addToRecentExports(type, format);

                // Restore button
                button.disabled = false;
                button.innerHTML = originalText;

            } catch (error) {
                console.error('Report generation error:', error);
                alert('Failed to generate report. Please try again.');
                event.target.closest('button').disabled = false;
            }
        }

        function downloadCSV(data, type) {
            let csv = '';
            let filename = `${type}-report-${new Date().toISOString().slice(0, 10)}.csv`;

            if (type === 'student-progress' && data.progress) {
                csv = 'ID,First Name,Last Name,Email,Student ID,Assessments Taken,Completed,Avg Score\n';
                data.progress.forEach(s => {
                    csv += `${s.id},"${s.first_name}","${s.last_name}","${s.email}","${s.student_id || ''}",${s.assessments_taken},${s.completed_attempts},${s.avg_score}\n`;
                });
            } else if (type === 'assessment-summary' && data.assessments) {
                csv = 'Step,Title,Completed Count,Average Score\n';
                data.assessments.forEach(a => {
                    csv += `${a.step},"${a.title}",${a.completedCount},${a.averageScore}\n`;
                });
            } else if (type === 'individual' && data.attempts) {
                csv = 'Assessment,Status,Score,Started,Completed,Duration (min)\n';
                data.attempts.forEach(a => {
                    const duration = a.duration ? Math.round(a.duration / 60) : '';
                    csv += `"${a.assessment_title}","${a.status}",${a.score || ''},"${new Date(a.started_at).toLocaleString()}","${a.submitted_at ? new Date(a.submitted_at).toLocaleString() : ''}",${duration}\n`;
                });
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function downloadJSON(data, type) {
            const filename = `${type}-report-${new Date().toISOString().slice(0, 10)}.json`;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function addToRecentExports(type, format) {
            const export_ = {
                type,
                format,
                timestamp: new Date().toISOString(),
                name: `${type.replace(/-/g, ' ')} Report`
            };

            recentExports.unshift(export_);
            if (recentExports.length > 10) recentExports.pop();

            displayRecentExports();
        }

        function displayRecentExports() {
            const container = document.getElementById('recentExports');

            if (recentExports.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-inbox"></i>
                        <p class="mt-2">No exports yet. Generate a report to get started.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Report Type</th>
                                <th>Format</th>
                                <th>Generated</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentExports.map(exp => `
                                <tr>
                                    <td>${exp.name}</td>
                                    <td><span class="badge bg-secondary">${exp.format.toUpperCase()}</span></td>
                                    <td>${new Date(exp.timestamp).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    </script>
</body>
</html>
