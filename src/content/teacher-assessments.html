<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessments</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link href="../assets/css/assessment-styles.css" rel="stylesheet">
</head>
<body style="background: white; padding: 0; margin: 0;">
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-gradient text-white" style="background: var(--bg-gradient);">
                    <div class="card-body py-4">
                        <h2 class="mb-2">
                            <i class="bi bi-file-text me-2"></i>
                            Assessments
                        </h2>
                        <p class="lead mb-0">View and manage course assessments</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessment Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="display-6 text-primary mb-2">
                            <i class="bi bi-clipboard-check"></i>
                        </div>
                        <h5 class="card-title mb-1" id="totalAssessments">0</h5>
                        <small class="text-muted">Total Assessments</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="display-6 text-success mb-2">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <h5 class="card-title mb-1" id="activeAssessments">0</h5>
                        <small class="text-muted">Active</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="display-6 text-info mb-2">
                            <i class="bi bi-people"></i>
                        </div>
                        <h5 class="card-title mb-1" id="totalAttempts">0</h5>
                        <small class="text-muted">Total Attempts</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="display-6 text-warning mb-2">
                            <i class="bi bi-trophy"></i>
                        </div>
                        <h5 class="card-title mb-1" id="averageScore">0%</h5>
                        <small class="text-muted">Average Score</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessments List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>All Assessments
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="assessmentsTable">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-3">Loading assessments...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Attempts -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>Recent Student Attempts
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="recentAttempts">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2">Loading recent attempts...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assessment Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Authentication Utils -->
    <script src="../assets/js/auth-utils.js"></script>

    <script>
        let assessments = [];
        let allAttempts = [];
        let detailsModal;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!authUtils.isAuthenticated()) {
                window.location.href = '../../index.html';
                return;
            }

            detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));
            await loadData();
        });

        async function loadData() {
            try {
                // Load assessments and attempts in parallel
                const [assessmentsResponse, attemptsResponse, statsResponse] = await Promise.all([
                    fetch('/api/assessments?endpoint=list', {
                        headers: { 'Authorization': `Bearer ${authUtils.getToken()}` }
                    }),
                    fetch('/api/student-data?type=attempts', {
                        headers: { 'Authorization': `Bearer ${authUtils.getToken()}` }
                    }),
                    fetch('/api/analytics?type=overview', {
                        headers: { 'Authorization': `Bearer ${authUtils.getToken()}` }
                    })
                ]);

                if (assessmentsResponse.ok) {
                    const data = await assessmentsResponse.json();
                    assessments = data.assessments || [];
                    displayAssessments();
                    updateStats();
                }

                if (attemptsResponse.ok) {
                    const data = await attemptsResponse.json();
                    allAttempts = data.attempts || [];
                    displayRecentAttempts();
                }

                if (statsResponse.ok) {
                    const data = await statsResponse.json();
                    updateStatsFromAPI(data);
                }

            } catch (error) {
                console.error('Failed to load data:', error);
                showError('Failed to load assessments');
            }
        }

        function updateStats() {
            const active = assessments.filter(a => a.is_active).length;
            document.getElementById('totalAssessments').textContent = assessments.length;
            document.getElementById('activeAssessments').textContent = active;
        }

        function updateStatsFromAPI(data) {
            if (data.assessments) {
                const totalAttempts = data.assessments.reduce((sum, a) => sum + (a.completedCount || 0), 0);
                const avgScore = totalAttempts > 0
                    ? Math.round(data.assessments.reduce((sum, a) => sum + (a.averageScore || 0) * (a.completedCount || 0), 0) / totalAttempts)
                    : 0;

                document.getElementById('totalAttempts').textContent = totalAttempts;
                document.getElementById('averageScore').textContent = avgScore + '%';
            }
        }

        function displayAssessments() {
            const container = document.getElementById('assessmentsTable');

            if (assessments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-2">No assessments available</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Step</th>
                                <th>Title</th>
                                <th>Questions</th>
                                <th>Duration</th>
                                <th>Passing Score</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${assessments.map(assessment => {
                                const statusClass = assessment.is_active ? 'success' : 'secondary';
                                const statusText = assessment.is_active ? 'Active' : 'Inactive';

                                return `
                                    <tr>
                                        <td><span class="badge bg-primary">Step ${assessment.step_number}</span></td>
                                        <td>${assessment.title}</td>
                                        <td>${assessment.total_questions || 0}</td>
                                        <td>${assessment.duration_minutes} min</td>
                                        <td>${assessment.passing_score}%</td>
                                        <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewDetails(${assessment.id})">
                                                <i class="bi bi-eye"></i> View
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function displayRecentAttempts() {
            const container = document.getElementById('recentAttempts');
            const recent = allAttempts.slice(0, 10);

            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-3 text-muted">
                        <i class="bi bi-inbox"></i>
                        <p class="mt-2">No attempts yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Assessment</th>
                                <th>Status</th>
                                <th>Score</th>
                                <th>Started</th>
                                <th>Completed</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recent.map(attempt => {
                                const statusClass = attempt.status === 'completed' || attempt.status === 'submitted' ? 'success' :
                                                   attempt.status === 'in_progress' ? 'warning' : 'secondary';
                                return `
                                    <tr>
                                        <td>Step ${attempt.assessment_step || attempt.assessment_id}</td>
                                        <td><span class="badge bg-${statusClass}">${attempt.status}</span></td>
                                        <td>${attempt.score !== null && attempt.score !== undefined ? attempt.score + '%' : '-'}</td>
                                        <td>${new Date(attempt.started_at).toLocaleString()}</td>
                                        <td>${attempt.submitted_at ? new Date(attempt.submitted_at).toLocaleString() : '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function viewDetails(assessmentId) {
            const assessment = assessments.find(a => a.id === assessmentId);
            if (!assessment) return;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <strong>Step Number:</strong> ${assessment.step_number}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Status:</strong>
                        <span class="badge bg-${assessment.is_active ? 'success' : 'secondary'}">
                            ${assessment.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="col-12 mb-3">
                        <strong>Title:</strong><br>
                        ${assessment.title}
                    </div>
                    <div class="col-12 mb-3">
                        <strong>Description:</strong><br>
                        ${assessment.description || 'No description available'}
                    </div>
                    <div class="col-md-4 mb-3">
                        <strong>Duration:</strong><br>
                        ${assessment.duration_minutes} minutes
                    </div>
                    <div class="col-md-4 mb-3">
                        <strong>Total Questions:</strong><br>
                        ${assessment.total_questions || 0}
                    </div>
                    <div class="col-md-4 mb-3">
                        <strong>Passing Score:</strong><br>
                        ${assessment.passing_score}%
                    </div>
                    <div class="col-12 mb-3">
                        <strong>Created:</strong><br>
                        ${new Date(assessment.created_at).toLocaleString()}
                    </div>
                </div>
            `;

            detailsModal.show();
        }

        function showError(message) {
            document.getElementById('assessmentsTable').innerHTML = `
                <div class="text-center py-4 text-danger">
                    <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                    <p class="mt-2">${message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
