<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Details</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link href="../assets/css/assessment-styles.css" rel="stylesheet">
</head>
<body style="background: white; padding: 0; margin: 0;">
    <div class="container-fluid py-4">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-3">Loading student details...</div>
        </div>

        <!-- Main Content (hidden initially) -->
        <div id="mainContent" style="display: none;">
            <!-- Student Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-gradient text-white" style="background: var(--bg-gradient);">
                        <div class="card-body py-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h2 class="mb-2">
                                        <i class="bi bi-person-circle me-2"></i>
                                        <span id="studentName">Student Name</span>
                                    </h2>
                                    <p class="lead mb-0" id="studentEmail">student@example.com</p>
                                </div>
                                <div class="col-md-4 text-md-end">
                                    <button class="btn btn-light btn-sm" onclick="goBack()">
                                        <i class="bi bi-arrow-left me-1"></i>Back to Students
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="display-6 text-primary mb-2">
                                <i class="bi bi-file-text"></i>
                            </div>
                            <h5 class="card-title mb-1" id="totalAttempts">0</h5>
                            <small class="text-muted">Total Attempts</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="display-6 text-success mb-2">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <h5 class="card-title mb-1" id="completedAttempts">0</h5>
                            <small class="text-muted">Completed</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="display-6 text-warning mb-2">
                                <i class="bi bi-clock"></i>
                            </div>
                            <h5 class="card-title mb-1" id="inProgressAttempts">0</h5>
                            <small class="text-muted">In Progress</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="display-6 text-info mb-2">
                                <i class="bi bi-trophy"></i>
                            </div>
                            <h5 class="card-title mb-1" id="averageScore">0%</h5>
                            <small class="text-muted">Average Score</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assessment Attempts -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-list-ul me-2"></i>Assessment Attempts
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="attemptsTable">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Chart -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-graph-up me-2"></i>Progress Over Time
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="progressChart">
                                <canvas id="scoreChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" style="display: none;" class="text-center py-5">
            <i class="bi bi-exclamation-triangle text-danger" style="font-size: 4rem;"></i>
            <h4 class="mt-3">Failed to Load Student Details</h4>
            <p class="text-muted" id="errorMessage">An error occurred while loading student information.</p>
            <button class="btn btn-primary" onclick="goBack()">
                <i class="bi bi-arrow-left me-1"></i>Back to Students
            </button>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Authentication Utils -->
    <script src="../assets/js/auth-utils.js"></script>

    <script>
        let studentId = null;
        let studentData = null;
        let attempts = [];

        document.addEventListener('DOMContentLoaded', () => {
            // Get student ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            studentId = urlParams.get('id');

            if (!studentId) {
                showError('No student ID provided');
                return;
            }

            loadStudentDetails();
        });

        async function loadStudentDetails() {
            try {
                // Load student info
                const studentResponse = await fetch(`/api/users/${studentId}`, {
                    headers: {
                        'Authorization': `Bearer ${authUtils.getToken()}`
                    }
                });

                if (!studentResponse.ok) {
                    throw new Error('Failed to load student information');
                }

                const studentResult = await studentResponse.json();
                studentData = studentResult.user || studentResult;

                // Load student attempts
                const attemptsResponse = await fetch(`/api/student-data?type=attempts&userId=${studentId}`, {
                    headers: {
                        'Authorization': `Bearer ${authUtils.getToken()}`
                    }
                });

                if (attemptsResponse.ok) {
                    const attemptsResult = await attemptsResponse.json();
                    attempts = Array.isArray(attemptsResult) ? attemptsResult : (attemptsResult.attempts || []);
                }

                displayStudentDetails();
                displayAttempts();
                createProgressChart();

            } catch (error) {
                console.error('Load student details error:', error);
                showError(error.message);
            }
        }

        function displayStudentDetails() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            document.getElementById('studentName').textContent =
                `${studentData.first_name} ${studentData.last_name}`;
            document.getElementById('studentEmail').textContent = studentData.email;

            // Calculate statistics
            const completedAttempts = attempts.filter(a => a.status === 'completed' || a.status === 'submitted');
            const inProgressAttempts = attempts.filter(a => a.status === 'in_progress');
            const avgScore = completedAttempts.length > 0
                ? Math.round(completedAttempts.reduce((sum, a) => sum + (a.score || 0), 0) / completedAttempts.length)
                : 0;

            document.getElementById('totalAttempts').textContent = attempts.length;
            document.getElementById('completedAttempts').textContent = completedAttempts.length;
            document.getElementById('inProgressAttempts').textContent = inProgressAttempts.length;
            document.getElementById('averageScore').textContent = avgScore + '%';
        }

        function displayAttempts() {
            const container = document.getElementById('attemptsTable');

            if (attempts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-2">No assessment attempts yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Assessment</th>
                                <th>Status</th>
                                <th>Score</th>
                                <th>Started</th>
                                <th>Completed</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${attempts.map(attempt => {
                                const statusClass = attempt.status === 'completed' || attempt.status === 'submitted' ? 'success' :
                                                   attempt.status === 'in_progress' ? 'warning' : 'secondary';
                                const startedDate = new Date(attempt.started_at).toLocaleString();
                                const completedDate = attempt.submitted_at ? new Date(attempt.submitted_at).toLocaleString() : '-';
                                const duration = attempt.submitted_at
                                    ? Math.round((new Date(attempt.submitted_at) - new Date(attempt.started_at)) / 60000) + ' min'
                                    : '-';

                                return `
                                    <tr>
                                        <td>Step ${attempt.assessment_step || attempt.assessment_id}</td>
                                        <td><span class="badge bg-${statusClass}">${attempt.status}</span></td>
                                        <td>${attempt.score !== null && attempt.score !== undefined ? attempt.score + '%' : '-'}</td>
                                        <td>${startedDate}</td>
                                        <td>${completedDate}</td>
                                        <td>${duration}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function createProgressChart() {
            const completedAttempts = attempts
                .filter(a => a.status === 'completed' || a.status === 'submitted')
                .sort((a, b) => new Date(a.started_at) - new Date(b.started_at));

            if (completedAttempts.length === 0) {
                document.getElementById('progressChart').innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-graph-up" style="font-size: 3rem;"></i>
                        <p class="mt-2">No completed assessments to display</p>
                    </div>
                `;
                return;
            }

            const ctx = document.getElementById('scoreChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: completedAttempts.map((a, i) => `Attempt ${i + 1}`),
                    datasets: [{
                        label: 'Score (%)',
                        data: completedAttempts.map(a => a.score || 0),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Score: ' + context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function goBack() {
            if (window.parent && window.parent.loadContent) {
                window.parent.loadContent('src/content/teacher-students.html');
            } else {
                window.history.back();
            }
        }
    </script>
</body>
</html>
