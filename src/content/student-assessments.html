<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Assessments</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link href="../assets/css/assessment-styles.css" rel="stylesheet">
</head>
<body style="background: white; padding: 0; margin: 0;">
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-gradient text-white" style="background: var(--bg-gradient);">
                    <div class="card-body py-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="mb-2">
                                    <i class="bi bi-clipboard-check me-2"></i>
                                    My Assessments
                                </h2>
                                <p class="lead mb-0">View your assessment attempts and continue where you left off</p>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <button class="btn btn-light btn-sm" onclick="startNewAssessment()">
                                    <i class="bi bi-plus-circle me-1"></i>Start New Assessment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessment Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="display-6 text-primary mb-2">
                            <i class="bi bi-file-text"></i>
                        </div>
                        <h5 class="card-title mb-1" id="totalAttempts">0</h5>
                        <small class="text-muted">Total Attempts</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="display-6 text-success mb-2">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <h5 class="card-title mb-1" id="completedAttempts">0</h5>
                        <small class="text-muted">Completed</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="display-6 text-warning mb-2">
                            <i class="bi bi-clock"></i>
                        </div>
                        <h5 class="card-title mb-1" id="inProgressAttempts">0</h5>
                        <small class="text-muted">In Progress</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <div class="display-6 text-info mb-2">
                            <i class="bi bi-trophy"></i>
                        </div>
                        <h5 class="card-title mb-1" id="bestScore">-</h5>
                        <small class="text-muted">Best Score</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assessment Attempts -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>Assessment History
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Loading state -->
                        <div id="attemptsLoading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Loading your assessment history...</div>
                        </div>

                        <!-- Attempts table -->
                        <div id="attemptsTable" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Assessment</th>
                                            <th>Started</th>
                                            <th>Status</th>
                                            <th>Score</th>
                                            <th>Duration</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attemptsTableBody">
                                        <!-- Dynamic content -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Empty state -->
                        <div id="emptyState" style="display: none;" class="text-center py-5">
                            <div class="text-muted">
                                <i class="bi bi-clipboard-x display-1"></i>
                                <h5 class="mt-3">No Assessment Attempts</h5>
                                <p>You haven't started any assessments yet. Click "Start New Assessment" to begin.</p>
                                <button class="btn btn-primary btn-sm" onclick="startNewAssessment()">
                                    <i class="bi bi-play-circle me-1"></i>Start Your First Assessment
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Authentication Utils -->
    <script src="../assets/js/auth-utils.js"></script>

    <script>
        // Load assessment attempts on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadAssessmentAttempts();
        });

        async function loadAssessmentAttempts() {
            try {
                if (!authUtils.isAuthenticated()) {
                    window.location.href = '../../index.html';
                    return;
                }

                const response = await fetch('/api/student-data?type=attempts', {
                    headers: {
                        'Authorization': `Bearer ${authUtils.getToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load attempts');
                }

                const data = await response.json();
                displayAttempts(data.attempts || []);
                updateStatistics(data.attempts || []);

            } catch (error) {
                console.error('Failed to load assessment attempts:', error);
                showError('Failed to load assessment history. Please try again.');
            }
        }

        function displayAttempts(attempts) {
            const loading = document.getElementById('attemptsLoading');
            const table = document.getElementById('attemptsTable');
            const emptyState = document.getElementById('emptyState');
            const tbody = document.getElementById('attemptsTableBody');

            loading.style.display = 'none';

            if (attempts.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'block';

            tbody.innerHTML = attempts.map(attempt => {
                const statusBadge = getStatusBadge(attempt.status);
                const score = (attempt.status === 'submitted' || attempt.status === 'graded') ? `${attempt.score}%` : '-';
                const duration = attempt.duration ? formatDuration(attempt.duration) : '-';
                const actions = getActionButtons(attempt);

                return `
                    <tr>
                        <td>
                            <div class="fw-semibold">Step ${attempt.assessment_step}: ${getAssessmentTitle(attempt.assessment_step)}</div>
                            <small class="text-muted">Assessment #${attempt.id}</small>
                        </td>
                        <td>${formatDate(attempt.started_at)}</td>
                        <td>${statusBadge}</td>
                        <td>${score}</td>
                        <td>${duration}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateStatistics(attempts) {
            const total = attempts.length;
            const completed = attempts.filter(a => a.status === 'submitted' || a.status === 'graded').length;
            const inProgress = attempts.filter(a => a.status === 'in_progress').length;
            const scores = attempts.filter(a => (a.status === 'submitted' || a.status === 'graded') && a.score).map(a => a.score);
            const bestScore = scores.length > 0 ? Math.max(...scores) : null;

            document.getElementById('totalAttempts').textContent = total;
            document.getElementById('completedAttempts').textContent = completed;
            document.getElementById('inProgressAttempts').textContent = inProgress;
            document.getElementById('bestScore').textContent = bestScore !== null ? `${bestScore}%` : '-';
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'submitted':
                case 'graded':
                    return '<span class="badge bg-success">Completed</span>';
                case 'in_progress':
                    return '<span class="badge bg-warning">In Progress</span>';
                case 'abandoned':
                    return '<span class="badge bg-secondary">Abandoned</span>';
                default:
                    return '<span class="badge bg-light text-dark">Unknown</span>';
            }
        }

        function getAssessmentTitle(step) {
            const titles = {
                1: 'Basic File Reading',
                2: 'Desktop API Integration',
                3: 'Advanced Topics'
            };
            return titles[step] || 'Unknown Assessment';
        }

        function getActionButtons(attempt) {
            if (attempt.status === 'in_progress') {
                return `
                    <button class="btn btn-primary btn-sm me-1" onclick="continueAssessment(${attempt.id})">
                        <i class="bi bi-play-circle me-1"></i>Continue
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="viewAttempt(${attempt.id})">
                        <i class="bi bi-eye me-1"></i>View
                    </button>
                `;
            } else if (attempt.status === 'completed') {
                return `
                    <button class="btn btn-outline-primary btn-sm me-1" onclick="viewResults(${attempt.id})">
                        <i class="bi bi-file-text me-1"></i>Results
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="retakeAssessment(${attempt.assessment_step})">
                        <i class="bi bi-arrow-clockwise me-1"></i>Retake
                    </button>
                `;
            } else {
                return `
                    <button class="btn btn-outline-secondary btn-sm" onclick="viewAttempt(${attempt.id})">
                        <i class="bi bi-eye me-1"></i>View
                    </button>
                `;
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function startNewAssessment() {
            // Load the assessment page in the parent frame
            parent.loadContent('src/assessments/step1-assessment.html');
        }

        function continueAssessment(attemptId) {
            // Continue an in-progress assessment
            parent.loadContent(`src/assessments/step1-assessment.html?attempt=${attemptId}`);
        }

        function viewAttempt(attemptId) {
            // View attempt details
            parent.loadContent(`src/assessments/attempt-details.html?id=${attemptId}`);
        }

        function viewResults(attemptId) {
            // View assessment results
            parent.loadContent(`src/assessments/attempt-results.html?id=${attemptId}`);
        }

        function retakeAssessment(step) {
            // Start a new attempt for the same assessment
            parent.loadContent(`src/assessments/step${step}-assessment.html`);
        }

        function showError(message) {
            const loading = document.getElementById('attemptsLoading');
            loading.innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    ${message}
                </div>
            `;
        }
    </script>
</body>
</html>