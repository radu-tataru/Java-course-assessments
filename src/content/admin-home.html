<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link href="../assets/css/assessment-styles.css" rel="stylesheet">
</head>
<body style="background: white; padding: 0; margin: 0;">
    <div class="container-fluid py-4">
        <!-- Welcome Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card text-white" style="background: linear-gradient(135deg, #dc3545, #6c757d);">
                    <div class="card-body py-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="mb-2">
                                    <i class="bi bi-shield-lock me-2"></i>
                                    Admin Dashboard
                                </h2>
                                <p class="lead mb-0" id="welcomeMessage">System administration and management</p>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <div class="d-flex flex-column align-items-md-end">
                                    <div class="btn-group">
                                        <button class="btn btn-light btn-sm" onclick="parent.loadContent('src/content/admin-users.html')">
                                            <i class="bi bi-people me-1"></i>Manage Users
                                        </button>
                                        <button class="btn btn-light btn-sm" onclick="parent.loadContent('src/content/admin-assessments.html')">
                                            <i class="bi bi-file-text me-1"></i>Assessments
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Statistics -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-people-fill text-primary" style="font-size: 2.5rem;"></i>
                        <h3 class="mt-3 mb-0" id="totalUsers">-</h3>
                        <p class="text-muted mb-0">Total Users</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-person-badge-fill text-success" style="font-size: 2.5rem;"></i>
                        <h3 class="mt-3 mb-0" id="totalTeachers">-</h3>
                        <p class="text-muted mb-0">Teachers</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-mortarboard-fill text-info" style="font-size: 2.5rem;"></i>
                        <h3 class="mt-3 mb-0" id="totalStudents">-</h3>
                        <p class="text-muted mb-0">Students</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="bi bi-file-earmark-check-fill text-warning" style="font-size: 2.5rem;"></i>
                        <h3 class="mt-3 mb-0" id="totalAssessments">-</h3>
                        <p class="text-muted mb-0">Assessments</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-gear me-2"></i>Java Course Assessment System
                        </h5>
                        <p class="card-text">
                            Welcome to the admin dashboard! Manage users, monitor system activity, configure assessments, and oversee the entire platform.
                            Use the navigation menu to access different administrative sections.
                        </p>
                        <div class="row mt-4">
                            <div class="col-md-3 text-center">
                                <i class="bi bi-people-fill text-primary me-2" style="font-size: 1.5rem;"></i>
                                <small class="d-block mt-2">User management</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <i class="bi bi-file-text-fill text-success me-2" style="font-size: 1.5rem;"></i>
                                <small class="d-block mt-2">Assessment configuration</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <i class="bi bi-graph-up-arrow text-info me-2" style="font-size: 1.5rem;"></i>
                                <small class="d-block mt-2">System analytics</small>
                            </div>
                            <div class="col-md-3 text-center">
                                <i class="bi bi-shield-lock text-danger me-2" style="font-size: 1.5rem;"></i>
                                <small class="d-block mt-2">Security & permissions</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity & System Health -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-activity me-2"></i>Recent System Activity
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="systemActivity">
                            <div class="text-center text-muted py-3">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2">Loading activity...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-speedometer2 me-2"></i>System Health
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="small">Database Connection</span>
                                <span class="badge bg-success">Healthy</span>
                            </div>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar bg-success" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="small">API Response Time</span>
                                <span class="badge bg-success">Fast</span>
                            </div>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar bg-success" style="width: 85%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="small">Active Sessions</span>
                                <span class="badge bg-info" id="activeSessions">-</span>
                            </div>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar bg-info" style="width: 60%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-lightning me-2"></i>Admin Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-outline-primary w-100" onclick="parent.loadContent('src/content/admin-users.html')">
                                    <i class="bi bi-people d-block mb-2" style="font-size: 2rem;"></i>
                                    <div class="fw-semibold">Manage Users</div>
                                    <small class="text-muted">Create, edit, and delete users</small>
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-outline-success w-100" onclick="parent.loadContent('src/content/admin-assessments.html')">
                                    <i class="bi bi-file-text d-block mb-2" style="font-size: 2rem;"></i>
                                    <div class="fw-semibold">Assessments</div>
                                    <small class="text-muted">Configure assessment settings</small>
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-outline-info w-100" onclick="parent.loadContent('src/content/admin-analytics.html')">
                                    <i class="bi bi-graph-up d-block mb-2" style="font-size: 2rem;"></i>
                                    <div class="fw-semibold">Analytics</div>
                                    <small class="text-muted">System-wide analytics</small>
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-outline-danger w-100" onclick="parent.loadContent('src/content/admin-settings.html')">
                                    <i class="bi bi-gear d-block mb-2" style="font-size: 2rem;"></i>
                                    <div class="fw-semibold">System Settings</div>
                                    <small class="text-muted">Configure system settings</small>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Authentication Utils -->
    <script src="../assets/js/auth-utils.js"></script>

    <script>
        // Load admin dashboard data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadAdminData();
            updateWelcomeMessage();
        });

        function updateWelcomeMessage() {
            const userData = authUtils.getUserData();
            if (userData) {
                document.getElementById('welcomeMessage').textContent =
                    `Welcome back, ${userData.firstName}! Complete control over the assessment system.`;
            }
        }

        async function loadAdminData() {
            try {
                if (!authUtils.isAuthenticated()) {
                    window.location.href = '../../index.html';
                    return;
                }

                // Load system statistics
                const statsResponse = await fetch('/api/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${authUtils.getToken()}`
                    }
                });

                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    updateSystemStats(statsData);
                } else {
                    // Fallback to basic user count
                    loadBasicStats();
                }

                // Load recent activity
                loadSystemActivity();

            } catch (error) {
                console.error('Failed to load admin data:', error);
                loadBasicStats();
            }
        }

        async function loadBasicStats() {
            try {
                const usersResponse = await fetch('/api/users', {
                    headers: {
                        'Authorization': `Bearer ${authUtils.getToken()}`
                    }
                });

                if (usersResponse.ok) {
                    const users = await usersResponse.json();
                    const teachers = users.filter(u => u.role === 'teacher').length;
                    const students = users.filter(u => u.role === 'student').length;

                    document.getElementById('totalUsers').textContent = users.length;
                    document.getElementById('totalTeachers').textContent = teachers;
                    document.getElementById('totalStudents').textContent = students;
                }

                const assessmentsResponse = await fetch('/api/assessments', {
                    headers: {
                        'Authorization': `Bearer ${authUtils.getToken()}`
                    }
                });

                if (assessmentsResponse.ok) {
                    const assessments = await assessmentsResponse.json();
                    document.getElementById('totalAssessments').textContent = assessments.length;
                }
            } catch (error) {
                console.error('Failed to load basic stats:', error);
            }
        }

        function updateSystemStats(data) {
            document.getElementById('totalUsers').textContent = data.totalUsers || 0;
            document.getElementById('totalTeachers').textContent = data.totalTeachers || 0;
            document.getElementById('totalStudents').textContent = data.totalStudents || 0;
            document.getElementById('totalAssessments').textContent = data.totalAssessments || 0;
            document.getElementById('activeSessions').textContent = data.activeSessions || 0;
        }

        async function loadSystemActivity() {
            const activityDiv = document.getElementById('systemActivity');

            try {
                const response = await fetch('/api/admin/activity', {
                    headers: {
                        'Authorization': `Bearer ${authUtils.getToken()}`
                    }
                });

                if (response.ok) {
                    const activities = await response.json();
                    displaySystemActivity(activities);
                } else {
                    activityDiv.innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-activity"></i>
                            <div class="mt-2">No recent activity</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load system activity:', error);
                activityDiv.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-exclamation-circle"></i>
                        <div class="mt-2">Failed to load activity</div>
                    </div>
                `;
            }
        }

        function displaySystemActivity(activities) {
            const activityDiv = document.getElementById('systemActivity');

            if (!activities || activities.length === 0) {
                activityDiv.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-activity"></i>
                        <div class="mt-2">No recent activity</div>
                    </div>
                `;
                return;
            }

            activityDiv.innerHTML = activities.slice(0, 5).map(activity => {
                const iconClass = getActivityIcon(activity.type);
                const timeAgo = getTimeAgo(activity.timestamp);
                return `
                    <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                        <div class="me-3">
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="bi ${iconClass} text-primary"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-semibold small">${activity.description}</div>
                            <div class="text-muted small">${timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getActivityIcon(type) {
            const icons = {
                'user_created': 'bi-person-plus',
                'user_login': 'bi-box-arrow-in-right',
                'assessment_submitted': 'bi-file-check',
                'assessment_created': 'bi-file-plus',
                'user_deleted': 'bi-person-x'
            };
            return icons[type] || 'bi-circle';
        }

        function getTimeAgo(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));

            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes} minutes ago`;
            if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)} hours ago`;
            return `${Math.floor(diffInMinutes / 1440)} days ago`;
        }
    </script>
</body>
</html>
